diff -uprk.orig nmap-3.77.orig/MACLookup.cc nmap-3.77/MACLookup.cc
--- nmap-3.77.orig/MACLookup.cc	2004-11-28 01:13:12 +0000
+++ nmap-3.77/MACLookup.cc	2004-11-28 01:20:48 +0000
@@ -105,6 +105,7 @@
 #include "MACLookup.h"
 #include "nmap.h"
 #include "nmap_error.h"
+#include "droppriv.h"
 
 struct MAC_entry {
   int prefix; /* -1 means none set */
@@ -128,7 +129,7 @@ static inline int MACTableHash(int prefi
   return prefix % table_capacity;
 }
 
-static void mac_prefix_init() {
+void mac_prefix_init() {
   static int initialized = 0;
   if (initialized) return;
   initialized = 1;
diff -uprk.orig nmap-3.77.orig/Makefile.in nmap-3.77/Makefile.in
--- nmap-3.77.orig/Makefile.in	2004-11-10 02:05:51 +0000
+++ nmap-3.77/Makefile.in	2004-11-28 01:20:48 +0000
@@ -46,11 +46,11 @@ TARGET = nmap
 TARGETNMAPFE=@TARGETNMAPFE@
 INSTALLNMAPFE=@INSTALLNMAPFE@
 
-SRCS = main.cc nmap.cc targets.cc tcpip.cc nmap_error.cc utils.cc idle_scan.cc osscan.cc output.cc scan_engine.cc timing.cc charpool.cc services.cc protocols.cc nmap_rpc.cc portlist.cc NmapOps.cc TargetGroup.cc Target.cc FingerPrintResults.cc service_scan.cc NmapOutputTable.cc MACLookup.cc @COMPAT_SRCS@
+SRCS = main.cc nmap.cc targets.cc tcpip.cc nmap_error.cc utils.cc idle_scan.cc osscan.cc output.cc scan_engine.cc timing.cc charpool.cc services.cc protocols.cc nmap_rpc.cc portlist.cc droppriv.cc NmapOps.cc TargetGroup.cc Target.cc FingerPrintResults.cc service_scan.cc NmapOutputTable.cc MACLookup.cc @COMPAT_SRCS@
 
-OBJS = main.o nmap.o targets.o tcpip.o nmap_error.o utils.o idle_scan.o osscan.o output.o scan_engine.o timing.o charpool.o services.o protocols.o nmap_rpc.o portlist.o NmapOps.o TargetGroup.o Target.o FingerPrintResults.o service_scan.o NmapOutputTable.o MACLookup.o @COMPAT_OBJS@
+OBJS = main.o nmap.o targets.o tcpip.o nmap_error.o utils.o idle_scan.o osscan.o output.o scan_engine.o timing.o charpool.o services.o protocols.o nmap_rpc.o portlist.o droppriv.o NmapOps.o TargetGroup.o Target.o FingerPrintResults.o service_scan.o NmapOutputTable.o MACLookup.o @COMPAT_OBJS@
 
-DEPS = nmap.h nmap_amigaos.h nmap_error.h targets.h idle_scan.h osscan.h output.h scan_engine.h timing.h tcpip.h utils.h global_structures.h charpool.h services.h protocols.h nmap_rpc.h portlist.h NmapOps.h TargetGroup.h Target.h FingerPrintResults.h service_scan.h NmapOutputTable.h MACLookup.h
+DEPS = nmap.h nmap_amigaos.h nmap_error.h targets.h idle_scan.h osscan.h output.h scan_engine.h timing.h tcpip.h utils.h global_structures.h charpool.h services.h protocols.h nmap_rpc.h portlist.h droppriv.h NmapOps.h TargetGroup.h Target.h FingerPrintResults.h service_scan.h NmapOutputTable.h MACLookup.h
 
 DATAFILES = nmap-os-fingerprints nmap-service-probes nmap-services nmap-rpc nmap-protocols nmap-mac-prefixes
 
diff -uprk.orig nmap-3.77.orig/configure.ac nmap-3.77/configure.ac
--- nmap-3.77.orig/configure.ac	2004-10-17 03:49:26 +0000
+++ nmap-3.77/configure.ac	2004-11-28 01:20:48 +0000
@@ -571,6 +571,7 @@ if test $ac_cv_ip_has_ip_sum = yes ; the
         AC_DEFINE(HAVE_IP_IP_SUM)
 fi
 
+AC_CHECK_LIB(cap, cap_from_text)
 
 dnl Checks for library functions.
 dnl AC_TYPE_SIGNAL
diff -uprk.orig nmap-3.77.orig/droppriv.cc nmap-3.77/droppriv.cc
--- nmap-3.77.orig/droppriv.cc	1970-01-01 00:00:00 +0000
+++ nmap-3.77/droppriv.cc	2004-11-28 01:20:48 +0000
@@ -0,0 +1,75 @@
+#include <stdlib.h>
+#include <error.h>
+#include <errno.h>
+#include <unistd.h>
+#include <pwd.h>
+#include <grp.h>
+#include <sys/capability.h>
+#include <sys/prctl.h>
+
+#include "nmap.h"
+#include "droppriv.h"
+#include "NmapOps.h"
+
+#define NMAP_USER "nmapuser"
+#define NMAP_CHROOT_EMPTY "/var/empty"
+#define NMAP_CHROOT_RESOLV "/var/resolv"
+
+extern NmapOps o;  /* option structure */
+
+void
+drop_priv (void)
+{
+	const char *user = NMAP_USER;
+	const char *dir;
+	struct passwd *pw;
+	cap_t   caps;
+
+	if (geteuid ())
+		return;
+
+	nmap_services_init ();
+	nmap_protocols_init ();
+	rpc_services_init ();
+	service_scan_init ();
+	routethrough_init ();
+	mac_prefix_init();
+
+	if (setgroups (0, 0) < 0)
+		error (EXIT_FAILURE, errno, "setgroups failed");
+
+	if (prctl (PR_SET_KEEPCAPS, 1))
+		error (EXIT_FAILURE, errno,
+		       "prctl (PR_SET_KEEPCAPS, 1) failed");
+
+	pw = getpwnam (user);
+	if (!pw)
+		error (EXIT_FAILURE, 0, "lookup of user \"%s\" failed", user);
+	endpwent ();
+
+	if (!pw->pw_uid)
+		error (EXIT_FAILURE, 0,
+		       "user \"%s\" shouldn't be root", user);
+
+	dir = o.noresolve ? NMAP_CHROOT_EMPTY : NMAP_CHROOT_RESOLV;
+	if (dir && (chroot (dir) || chdir ("/")))
+		error (EXIT_FAILURE, errno, "chroot to \"%s\" failed", dir);
+
+	if (setgid (pw->pw_gid) < 0)
+		error (EXIT_FAILURE, errno, "setgid failed");
+
+	if (seteuid (pw->pw_uid) < 0)
+		error (EXIT_FAILURE, errno, "seteuid failed");
+
+	caps = cap_from_text ("cap_net_raw=ep");
+	if (!caps)
+		error (EXIT_FAILURE, errno, "cap_from_text failed");
+
+	if (cap_set_proc (caps) < 0)
+		error (EXIT_FAILURE, errno, "cap_set_proc failed");
+
+	cap_free (caps);
+
+	if (setreuid (pw->pw_uid, pw->pw_uid) < 0)
+		error (EXIT_FAILURE, errno, "setreuid failed");
+}
diff -uprk.orig nmap-3.77.orig/droppriv.h nmap-3.77/droppriv.h
--- nmap-3.77.orig/droppriv.h	1970-01-01 00:00:00 +0000
+++ nmap-3.77/droppriv.h	2004-11-28 01:20:48 +0000
@@ -0,0 +1,15 @@
+#ifndef NMAP_DROPPRIV_H__
+#define NMAP_DROPPRIV_H__
+
+class AllProbes;
+
+extern void drop_priv(void);
+extern int nmap_services_init(void);
+extern int nmap_protocols_init(void);
+extern void rpc_services_init(void);
+extern AllProbes *service_scan_init(void);
+extern void routethrough_init(void);
+extern void mac_prefix_init(void);
+
+#endif /* NMAP_DROPPRIV_H__ */
+
diff -uprk.orig nmap-3.77.orig/nmap.cc nmap-3.77/nmap.cc
--- nmap-3.77.orig/nmap.cc	2004-11-10 03:48:26 +0000
+++ nmap-3.77/nmap.cc	2004-11-28 01:20:48 +0000
@@ -105,6 +105,7 @@
 #include "scan_engine.h"
 #include "idle_scan.h"
 #include "timing.h"
+#include "droppriv.h"
 #include "NmapOps.h"
 
 /* global options */
@@ -797,6 +798,8 @@ int nmap_main(int argc, char *argv[]) {
     }
   }
 
+  drop_priv();
+
   /* By now, we've got our port lists.  Give the user a warning if no 
    * ports are specified for the type of scan being requested.  Other things
    * (such as OS ident scan) might break cause no ports were specified,  but
diff -uprk.orig nmap-3.77.orig/nmap_rpc.cc nmap-3.77/nmap_rpc.cc
--- nmap-3.77.orig/nmap_rpc.cc	2004-11-28 01:13:12 +0000
+++ nmap-3.77/nmap_rpc.cc	2004-11-28 01:20:48 +0000
@@ -103,6 +103,7 @@
 
 
 #include "nmap_rpc.h"
+#include "droppriv.h"
 #include "NmapOps.h"
 
 extern NmapOps o;
@@ -117,7 +118,7 @@ static unsigned long rpc_xid_base = (uns
 static size_t tcp_readlen=0; /* used in get_rpc_results but can be reset in 
 			    send_rpc_query */
 
-static void rpc_services_init() {
+void rpc_services_init() {
   static int services_initialized = 0;
   char filename[512];
   FILE *fp;
diff -uprk.orig nmap-3.77.orig/protocols.cc nmap-3.77/protocols.cc
--- nmap-3.77.orig/protocols.cc	2004-11-28 01:13:12 +0000
+++ nmap-3.77/protocols.cc	2004-11-28 01:20:48 +0000
@@ -100,13 +100,14 @@
 /* $Id: protocols.cc,v 1.11 2004/08/29 09:12:03 fyodor Exp $ */
 
 #include "protocols.h"
+#include "droppriv.h"
 #include "NmapOps.h"
 
 extern NmapOps o;
 static int numipprots = 0;
 static struct protocol_list *protocol_table[PROTOCOL_TABLE_SIZE];
 
-static int nmap_protocols_init() {
+int nmap_protocols_init() {
   static int protocols_initialized = 0;
   char filename[512];
   FILE *fp;
diff -uprk.orig nmap-3.77.orig/service_scan.cc nmap-3.77/service_scan.cc
--- nmap-3.77.orig/service_scan.cc	2004-11-28 01:13:12 +0000
+++ nmap-3.77/service_scan.cc	2004-11-28 01:21:54 +0000
@@ -105,6 +105,7 @@
 #include "timing.h"
 #include "NmapOps.h"
 #include "nsock.h"
+#include "droppriv.h"
 #if HAVE_OPENSSL
 #include <openssl/ssl.h>
 #endif
@@ -2061,7 +2062,7 @@ static void startTimeOutClocks(ServiceGr
   }
 }
 
-static AllProbes *service_scan_init(void)
+AllProbes *service_scan_init(void)
 {
   static AllProbes *AP;
 
diff -uprk.orig nmap-3.77.orig/services.cc nmap-3.77/services.cc
--- nmap-3.77.orig/services.cc	2004-11-28 01:13:12 +0000
+++ nmap-3.77/services.cc	2004-11-28 01:20:48 +0000
@@ -100,6 +100,7 @@
 /* $Id: services.cc,v 1.15 2004/08/29 09:12:03 fyodor Exp $ */
 
 #include "services.h"
+#include "droppriv.h"
 #include "NmapOps.h"
 
 extern NmapOps o;
@@ -107,7 +108,7 @@ static int numtcpports = 0;
 static int numudpports = 0;
 static struct service_list *service_table[SERVICE_TABLE_SIZE];
 
-static int nmap_services_init() {
+int nmap_services_init() {
   static int services_initialized = 0;
   char filename[512];
   FILE *fp;
diff -uprk.orig nmap-3.77.orig/tcpip.cc nmap-3.77/tcpip.cc
--- nmap-3.77.orig/tcpip.cc	2004-11-04 01:23:10 +0000
+++ nmap-3.77/tcpip.cc	2004-11-28 01:25:31 +0000
@@ -102,6 +102,7 @@
 
 
 #include "tcpip.h"
+#include "droppriv.h"
 #include "NmapOps.h"
 
 #if HAVE_SYS_TIME_H
@@ -1875,6 +1876,14 @@ int flt_icmptcp_5port(const char *packet
 #ifndef WIN32 /* Currently the Windows code for next few functions is 
                  in wintcpip.c -- should probably be merged at some
 				 point */
+static FILE *routez;
+
+void routethrough_init(void)
+{
+    if (!routez)
+        routez = fopen("/proc/net/route", "r");
+}
+
 int ipaddr2devname( char *dev, const struct in_addr *addr ) {
 struct interface_info *mydevs;
 int numdevs;
@@ -2071,7 +2080,6 @@ char *routethrough(const struct in_addr 
   char *p, *endptr;
   char iface[64];
   static int numroutes = 0;
-  FILE *routez;
 
   if (!dest) fatal("routethrough passed a NULL dest address");
 
@@ -2082,7 +2090,7 @@ char *routethrough(const struct in_addr 
     myroutes_capacity = 64;
     myroutes = (struct myroute *) safe_malloc((sizeof(struct myroute) * myroutes_capacity));
     /* Now we must go through several techniques to determine info */
-    routez = fopen("/proc/net/route", "r");
+    routethrough_init();
 
     if (routez) {
       /* OK, linux style /proc/net/route ... we can handle this ... */
@@ -2144,6 +2152,7 @@ char *routethrough(const struct in_addr 
 	  }
       }
       fclose(routez);
+      routez = NULL;
     } else {
       technique = connectsockettechnique;
     }
